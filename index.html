<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¾ç¥åŠ©æ‰‹ - å°ˆæ¥­ç©ºèª¿é‹ç®—</title>
    <link rel="icon" href="icon.png" type="image/png" sizes="512x512">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#1a1a1a">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* åŸºç¤æ’ç‰ˆèˆ‡é¾ç¥æš—é‡‘è‰²ç³» */
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        
        /* é ‚éƒ¨å°èˆªèˆ‡åˆ†é  */
        header {
            background: linear-gradient(145deg, #2a2a2a, #151515);
            padding: 15px 20px 0 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-top {
            display: flex;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
        }
        .header-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        h1 {
            margin: 0;
            color: #ffd700;
            font-size: 1.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .header-tabs {
            display: flex;
            width: 100%;
            overflow-x: auto;
            -ms-overflow-style: none; 
            scrollbar-width: none; 
        }
        .header-tabs::-webkit-scrollbar {
            display: none; 
        }
        .tab-btn {
            background: transparent;
            color: #aaaaaa;
            border: none;
            font-size: 1.1em;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: 0.3s;
            white-space: nowrap; 
        }
        .tab-btn.active {
            color: #ffd700;
            border-bottom: 2px solid #ffd700;
        }

        /* å…§å®¹å€å¡Š */
        .tab-content {
            display: none;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        .tab-content.active {
            display: block;
        }

        /* ç©ºé–“å¡ç‰‡è¨­è¨ˆ */
        .space-card {
            background: #242424;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .space-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        .space-title-input {
            background: transparent;
            border: none;
            color: #ffd700;
            font-size: 1.3em;
            font-weight: bold;
            width: 70%;
            outline: none;
        }
        .space-title-input::placeholder { color: #888; }

        .delete-btn {
            background: transparent;
            color: #ff4c4c;
            border: 1px solid #ff4c4c;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: 0.2s;
            white-space: nowrap;
        }
        .delete-btn:hover {
            background: #ff4c4c;
            color: white;
        }

        /* è¡¨å–®èˆ‡é¸é …ç¶²æ ¼ */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
            white-space: nowrap; 
        }
        .input-group input[type="number"], .input-group input[type="password"] {
            width: 100%;
            box-sizing: border-box;
            padding: 10px; 
            border-radius: 5px;
            border: 1px solid #444;
            background: #1a1a1a;
            color: #fff;
            outline: none;
            font-size: 1em;
        }
        .input-group input:focus {
            border-color: #ffd700;
        }
        
        .ping-input {
            color: #ffd700 !important;
            font-weight: bold;
        }
        
        /* ç’°å¢ƒé¸é …å€å¡Š */
        .options-section {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .options-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        .options-row:last-child { margin-bottom: 0; }
        .option-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.95em;
            color: #ddd;
            white-space: nowrap;
        }
        .option-label input { margin-right: 5px; }

        /* çµæœé¡¯ç¤º */
        .result-box {
            text-align: right;
            font-size: 1.15em; 
            color: #ffd700;
            font-weight: bold;
            padding-top: 10px;
        }

        /* åº•éƒ¨æ“ä½œæŒ‰éˆ• */
        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 40px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-add { background: linear-gradient(145deg, #ffd700, #d4af37); color: #1a1a1a; }
        .btn-pdf { background: #4a90e2; color: white; }
        .btn-reset { background: transparent; border: 2px solid #ff4c4c; color: #ff4c4c; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:active:not(:disabled) { transform: scale(0.95); }

        /* â˜… VIP å­åˆ†é å°èˆªåˆ— â˜… */
        .vip-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1e1e1e;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .subtabs-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .subtabs-container::-webkit-scrollbar { display: none; }
        .subtab-btn {
            background: transparent;
            color: #888;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 6px 12px;
            font-size: 0.95em;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        .subtab-btn.active {
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
            border-color: #ffd700;
        }
        .subtab-content { display: none; }
        .subtab-content.active { display: block; }

        /* â˜… é€¾æ™‚è­¦å‘Šå½ˆçª— â˜… */
        #timeout-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-box {
            background: #242424;
            border: 1px solid #ffd700;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            max-width: 85%;
            width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
        }
        .modal-title { color: #ffd700; font-size: 1.5em; font-weight: bold; margin-bottom: 15px; }
        .modal-desc { color: #ddd; font-size: 1.1em; line-height: 1.5; margin-bottom: 25px; }
        .modal-countdown { color: #ff4c4c; font-weight: bold; font-size: 1.3em; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
    </style>
</head>
<body>

    <div id="main-ui">
        <header>
            <div class="header-top">
                <img src="icon.png" alt="é¾ç¥" class="header-logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIgZmlsbD0iI2ZmZDcwMCIvPjwvc3ZnPg=='">
                <h1>é¾ç¥åŠ©æ‰‹</h1>
            </div>
            <div class="header-tabs">
                <button class="tab-btn active" onclick="switchTab('calc')">è² è¼‰è¨ˆç®—</button>
                <button class="tab-btn" onclick="switchTab('vip')">VIP å°ˆå€</button>
            </div>
        </header>

        <div id="calc" class="tab-content active">
            <div id="spaces-container"></div>
            <div class="action-bar">
                <button class="btn btn-add" onclick="addSpace()">+ æ–°å¢ç©ºé–“</button>
                <button class="btn btn-pdf" id="btn-export" onclick="exportPDF()">åŒ¯å‡º PDF è¡¨å–®</button>
                <button class="btn btn-reset" onclick="resetAll()">é‡ç½®è³‡æ–™</button>
            </div>
        </div>

        <div id="vip" class="tab-content">
            
            <div id="vip-login-view" class="space-card" style="border: 1px solid #ffd700; background: linear-gradient(145deg, #1a1a1a, #2a2a2a);">
                <div class="input-group">
                    <label style="color: #ffd700; font-size: 1em; margin-bottom: 10px;">ğŸ‘‘ VIP ç³»çµ±æˆæ¬Šç¢¼</label>
                    <input type="password" id="vip-master-pwd" placeholder="è«‹è¼¸å…¥æˆæ¬Šç¢¼è§£é–å°ˆæ¥­åŠŸèƒ½" style="border-color: #ffd700; font-size: 1.2em; letter-spacing: 2px;">
                </div>
                <button class="btn btn-add" style="margin-top: 15px; width: 100%;" id="btn-verify" onclick="verifyPassword()">ç¢ºèªè§£é–</button>
                <div id="login-msg" style="color: #ff4c4c; margin-top: 10px; font-size: 0.9em; text-align: center; font-weight: bold;"></div>
            </div>

            <div id="vip-dashboard-view" style="display: none;">
                <div class="vip-nav">
                    <div class="subtabs-container">
                        <button class="subtab-btn active" onclick="switchSubTab('flange')">åŠéš±å¼é¢¨ç®¡è¦åŠƒ</button>
                        </div>
                    <button class="delete-btn" style="border: 1px solid #ff4c4c;" onclick="logout()">ç™»å‡º</button>
                </div>

                <div id="sub-flange" class="subtab-content active">
                    <div id="flanges-container"></div>
                    
                    <div class="action-bar">
                        <button class="btn btn-add" onclick="addFlange()">+ æ–°å¢é…ç½®</button>
                        <button class="btn btn-pdf" id="btn-export-flange" onclick="exportFlangePDF()">åŒ¯å‡º PDF è¡¨å–®</button>
                        <button class="btn btn-reset" onclick="resetFlanges()">é‡ç½®è³‡æ–™</button>
                    </div>
                </div>
                
                </div>
        </div>
    </div>

    <div id="timeout-modal">
        <div class="modal-box">
            <div class="modal-title">â³ å³å°‡è‡ªå‹•ç™»å‡º</div>
            <div class="modal-desc">
                ç‚ºä¿è­·æ‚¨çš„ç³»çµ±æˆæ¬Šå®‰å…¨ï¼Œé–’ç½®éä¹…å³å°‡å¼·åˆ¶ç™»å‡ºã€‚<br><br>
                å€’æ•¸ <span id="countdown-sec" class="modal-countdown">60</span> ç§’...
            </div>
            <div class="modal-actions">
                <button class="btn btn-add" style="font-size: 1em; padding: 10px 15px;" onclick="keepSession()">ä¿ç•™ç™»å…¥</button>
                <button class="btn btn-reset" style="font-size: 1em; padding: 10px 15px;" onclick="logout()">ç›´æ¥ç™»å‡º</button>
            </div>
        </div>
    </div>

    <script>
        let appState = {
            spaces: [], spaceCounter: 1,
            flanges: [], flangeCounter: 1
        };

        // ç™»å…¥ç‹€æ…‹ã€é˜²æš´ç ´ã€è¨ˆæ™‚å™¨
        let isLoggedIn = false;
        let currentAuthToken = "";
        let lockoutData = { attempts: 0, lockUntil: 0 };
        let lockoutTimer = null;
        let flangeTimers = {};
        
        // è‡ªå‹•ç™»å‡ºè¨ˆæ™‚å™¨åƒæ•¸
        let sessionTimeoutTimer = null;
        let countdownInterval = null;
        const SESSION_DURATION = 30 * 60 * 1000; // 30 åˆ†é˜ (æ¯«ç§’)
        let remainingSeconds = 60;

        function loadData() {
            const savedData = localStorage.getItem('dragonGodSpaces');
            if (savedData) {
                let parsed = JSON.parse(savedData);
                if (Array.isArray(parsed)) {
                    appState.spaces = parsed;
                    appState.spaceCounter = parsed.length + 1;
                } else {
                    appState.spaces = parsed.spaces || [];
                    appState.spaceCounter = parsed.spaceCounter || 1;
                    appState.flanges = parsed.flanges || [];
                    appState.flangeCounter = parsed.flangeCounter || 1;
                }
            }

            // â˜… å¼·åˆ¶é‡ç½® VIP å­åˆ†é è³‡æ–™é¡¯ç¤º (é˜²æ­¢é‡æ•´ç¶²é å·çœ‹)
            appState.flanges.forEach(f => {
                f.area = 0;
                f.resultHtml = "å»ºè­°é…ç½®ï¼šç„¡é¡¯ç¤ºçµæœ";
            });

            if (appState.spaces.length === 0) { addSpace(); } else { renderSpaces(); }
            if (appState.flanges.length === 0) { addFlange(); } else { renderFlanges(); }

            loadLockout();
        }

        function saveDataSilently() {
            localStorage.setItem('dragonGodSpaces', JSON.stringify(appState));
        }

        /* ================================
           â˜… ç³»çµ±ç™»å…¥èˆ‡é˜²æš´ç ´æ©Ÿåˆ¶
           ================================ */
        function loadLockout() {
            let saved = localStorage.getItem('dragonGodLockout');
            if (saved) { lockoutData = JSON.parse(saved); }
            checkLockoutStatus();
        }

        function saveLockout() {
            localStorage.setItem('dragonGodLockout', JSON.stringify(lockoutData));
        }

        function checkLockoutStatus() {
            let now = Date.now();
            let btn = document.getElementById('btn-verify');
            let input = document.getElementById('vip-master-pwd');
            let msg = document.getElementById('login-msg');

            if (lockoutData.lockUntil > now) {
                btn.disabled = true; input.disabled = true;
                if (!lockoutTimer) { lockoutTimer = setInterval(checkLockoutStatus, 1000); }
                let remainSec = Math.ceil((lockoutData.lockUntil - now) / 1000);
                let m = Math.floor(remainSec / 60); let s = remainSec % 60;
                msg.innerText = `âš ï¸ éŒ¯èª¤æ¬¡æ•¸éå¤šï¼Œç³»çµ±å·²é–å®šï¼è«‹ç­‰å¾… ${m} åˆ† ${s} ç§’å¾Œé‡è©¦`;
            } else {
                if (lockoutData.lockUntil > 0) {
                    lockoutData.attempts = 0; lockoutData.lockUntil = 0; saveLockout();
                }
                if (lockoutTimer) { clearInterval(lockoutTimer); lockoutTimer = null; }
                if (!isLoggedIn) {
                    btn.disabled = false; input.disabled = false;
                    if (msg.innerText.includes("è«‹ç­‰å¾…")) msg.innerText = "";
                }
            }
        }

        function handleFailedAttempt() {
            lockoutData.attempts++;
            if (lockoutData.attempts >= 10) {
                lockoutData.lockUntil = Date.now() + 30 * 60 * 1000;
                document.getElementById('login-msg').innerText = "é€£çºŒéŒ¯èª¤ 10 æ¬¡ï¼Œå·²é–å®š 30 åˆ†é˜ï¼";
            } else {
                let left = 10 - lockoutData.attempts;
                document.getElementById('login-msg').innerText = `âŒ æˆæ¬Šç¢¼ç„¡æ•ˆï¼Œå‰©é¤˜å˜—è©¦æ¬¡æ•¸ï¼š${left} æ¬¡`;
            }
            saveLockout(); checkLockoutStatus();
        }

        async function verifyPassword() {
            let pwd = document.getElementById('vip-master-pwd').value;
            let msg = document.getElementById('login-msg');
            if (!pwd) { msg.innerText = "è«‹è¼¸å…¥æˆæ¬Šç¢¼ï¼"; return; }

            let btn = document.getElementById('btn-verify');
            btn.innerText = "é©—è­‰ä¸­..."; btn.disabled = true; msg.innerText = "";

            try {
                // ç™¼é€ç©ºè³‡æ–™é€²è¡Œé©—è­‰
                const response = await fetch('https://ryujin-god-api.mondogshahan.workers.dev', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ w: 0, h: 0, t: 0, password: pwd })
                });
                const data = await response.json();

                if (data.error && (data.error.includes("å¯†ç¢¼") || data.error.includes("æ‹’çµ•"))) {
                    handleFailedAttempt();
                    btn.innerText = "ç¢ºèªè§£é–";
                    if(lockoutData.lockUntil <= Date.now()) btn.disabled = false;
                } else {
                    loginSuccess(pwd);
                }
            } catch (e) {
                msg.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹";
                btn.innerText = "ç¢ºèªè§£é–"; btn.disabled = false;
            }
        }

        function loginSuccess(pwd) {
            currentAuthToken = pwd;
            isLoggedIn = true;
            
            lockoutData.attempts = 0; lockoutData.lockUntil = 0; saveLockout();

            document.getElementById('btn-verify').disabled = false;
            document.getElementById('btn-verify').innerText = "ç¢ºèªè§£é–";

            document.getElementById('vip-login-view').style.display = 'none';
            document.getElementById('vip-dashboard-view').style.display = 'block';

            // â˜… å•Ÿå‹• 30 åˆ†é˜é–’ç½®è¨ˆæ™‚å™¨
            resetSessionTimer();

            appState.flanges.forEach(f => {
                if (f.w && f.h) { fetchCloudflareAPI(f); } 
                else { f.resultHtml = "å»ºè­°é…ç½®ï¼šè«‹è¼¸å…¥å°ºå¯¸"; }
            });
            renderFlanges();
        }

        function logout() {
            currentAuthToken = "";
            isLoggedIn = false;
            document.getElementById('vip-master-pwd').value = '';
            document.getElementById('login-msg').innerText = "âœ… å·²æˆåŠŸç™»å‡ºï¼Œæ©Ÿå¯†çµæœå·²é®è”½";

            document.getElementById('btn-verify').disabled = false;
            document.getElementById('btn-verify').innerText = "ç¢ºèªè§£é–";

            document.getElementById('vip-login-view').style.display = 'block';
            document.getElementById('vip-dashboard-view').style.display = 'none';

            // â˜… ç™»å‡ºæ™‚åœæ­¢æ‰€æœ‰è¨ˆæ™‚å™¨èˆ‡éš±è—å½ˆçª—
            clearTimeout(sessionTimeoutTimer);
            clearInterval(countdownInterval);
            document.getElementById('timeout-modal').style.display = 'none';

            appState.flanges.forEach(f => {
                f.area = 0;
                f.resultHtml = "å»ºè­°é…ç½®ï¼šç„¡é¡¯ç¤ºçµæœ";
            });
            saveDataSilently(); renderFlanges();
        }

        /* ================================
           â˜… é–’ç½®è‡ªå‹•ç™»å‡ºé‚è¼¯
           ================================ */
        function resetSessionTimer() {
            clearTimeout(sessionTimeoutTimer);
            clearInterval(countdownInterval);
            if (isLoggedIn) {
                // è¨­å®š 30 åˆ†é˜å¾Œè§¸ç™¼å½ˆçª—
                sessionTimeoutTimer = setTimeout(showTimeoutModal, SESSION_DURATION);
            }
        }

        function showTimeoutModal() {
            document.getElementById('timeout-modal').style.display = 'flex';
            remainingSeconds = 60;
            document.getElementById('countdown-sec').innerText = remainingSeconds;
            
            // é–‹å§‹ 60 ç§’å€’æ•¸ï¼Œæ™‚é–“åˆ°å¼·åˆ¶ç™»å‡º
            countdownInterval = setInterval(() => {
                remainingSeconds--;
                document.getElementById('countdown-sec').innerText = remainingSeconds;
                if (remainingSeconds <= 0) {
                    clearInterval(countdownInterval);
                    logout();
                    document.getElementById('login-msg').innerText = "âš ï¸ é–’ç½®éä¹…ï¼Œç³»çµ±å·²è‡ªå‹•ç‚ºæ‚¨ç™»å‡ºä¿è­·è³‡æ–™ã€‚";
                }
            }, 1000);
        }

        function keepSession() {
            // é»æ“Šä¿ç•™ç™»å…¥ï¼Œé—œé–‰å½ˆçª—ä¸¦é‡æ–°è¨ˆæ™‚ 30 åˆ†é˜
            document.getElementById('timeout-modal').style.display = 'none';
            resetSessionTimer();
        }

        // ç¶å®šç¶²é æ“ä½œäº‹ä»¶ï¼Œæœ‰å‹•éœå°±é‡ç½®è¨ˆæ™‚å™¨ (è§¸æ§ã€é»æ“Šã€è¼¸å…¥)
        document.addEventListener('click', () => { if(isLoggedIn) resetSessionTimer(); });
        document.addEventListener('input', () => { if(isLoggedIn) resetSessionTimer(); });

        /* ================================
           ä¸»åˆ†é èˆ‡å­åˆ†é åˆ‡æ›é‚è¼¯
           ================================ */
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function switchSubTab(tabId) {
            document.querySelectorAll('.subtab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.subtab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('sub-' + tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        /* ================================
           åˆ†é  1: è² è¼‰è¨ˆç®—å€å¡Š
           ================================ */
        function addSpace() {
            const newId = Date.now().toString();
            appState.spaces.push({ id: newId, name: 'ç©ºé–“' + appState.spaceCounter, length: '', width: '', ping: '', sun: 'none', roof: 'none', topFloor: false, highCeiling: false, kw: 0 });
            appState.spaceCounter++; saveDataSilently(); renderSpaces(); 
        }
        function removeSpace(id) {
            if (appState.spaces.length <= 1) { alert("ç„¡æ³•åˆªé™¤ï¼è¡¨å–®ä¸­è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç©ºé–“ã€‚"); return; }
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹ç©ºé–“çš„è³‡æ–™å—ï¼Ÿ")) { appState.spaces = appState.spaces.filter(s => s.id !== id); saveDataSilently(); renderSpaces(); }
        }
        function updateField(id, field, value) {
            const space = appState.spaces.find(s => s.id === id);
            if (!space) return;
            space[field] = value;
            if (field === 'length' || field === 'width') {
                const l = parseFloat(space.length) || 0; const w = parseFloat(space.width) || 0;
                if (l > 0 && w > 0) {
                    space.ping = (((l / 100) * (w / 100)) * 0.3025).toFixed(2);
                    document.getElementById('ping_' + id).value = space.ping;
                } else { space.ping = ''; document.getElementById('ping_' + id).value = ''; }
            }
            const pingVal = parseFloat(space.ping) || 0;
            let kwVal = pingVal * 0.6; 
            if (kwVal > 0) {
                if (space.sun === 'west') kwVal *= 1.15; if (space.sun === 'all') kwVal *= 1.25;
                if (space.topFloor) kwVal *= 1.15; if (space.highCeiling) kwVal *= 1.10;
                if (space.roof === 'tin') kwVal *= 1.20; if (space.roof === 'black_tin') kwVal *= 1.30;
            }
            space.kw = kwVal.toFixed(2);
            document.getElementById('result_' + id).innerText = 'å»ºè­°èƒ½åŠ›ï¼šç´„ ' + space.kw + ' kW';
            saveDataSilently();
        }
        function renderSpaces() {
            const container = document.getElementById('spaces-container');
            container.innerHTML = '';
            appState.spaces.forEach((space) => {
                const card = document.createElement('div'); card.className = 'space-card';
                card.innerHTML = `
                    <div class="space-header">
                        <input type="text" class="space-title-input" placeholder="ç©ºé–“åç¨±" value="${space.name}" oninput="updateField('${space.id}', 'name', this.value)">
                        <button class="delete-btn" onclick="removeSpace('${space.id}')">åˆªé™¤</button>
                    </div>
                    <div class="input-grid">
                        <div class="input-group"><label>é•·åº¦ (cm)</label><input type="number" placeholder="å…¬åˆ†" value="${space.length}" oninput="updateField('${space.id}', 'length', this.value)"></div>
                        <div class="input-group"><label>å¯¬åº¦ (cm)</label><input type="number" placeholder="å…¬åˆ†" value="${space.width}" oninput="updateField('${space.id}', 'width', this.value)"></div>
                        <div class="input-group"><label>åªæ•¸</label><input type="number" id="ping_${space.id}" class="ping-input" step="0.01" placeholder="å¯æ‰‹å‹•" value="${space.ping}" oninput="updateField('${space.id}', 'ping', this.value)"></div>
                    </div>
                    <div class="options-section">
                        <div class="options-row">
                            <label class="option-label"><input type="radio" name="sun_${space.id}" value="none" ${space.sun === 'none' ? 'checked' : ''} onchange="updateField('${space.id}', 'sun', this.value)"> ç„¡è¥¿æ›¬</label>
                            <label class="option-label"><input type="radio" name="sun_${space.id}" value="west" ${space.sun === 'west' ? 'checked' : ''} onchange="updateField('${space.id}', 'sun', this.value)"> è¥¿æ›¬</label>
                            <label class="option-label"><input type="radio" name="sun_${space.id}" value="all" ${space.sun === 'all' ? 'checked' : ''} onchange="updateField('${space.id}', 'sun', this.value)"> å…¨æ—¥æ›¬</label>
                        </div>
                        <div class="options-row">
                            <label class="option-label"><input type="checkbox" ${space.topFloor ? 'checked' : ''} onchange="updateField('${space.id}', 'topFloor', this.checked)"> é ‚æ¨“</label>
                            <label class="option-label"><input type="checkbox" ${space.highCeiling ? 'checked' : ''} onchange="updateField('${space.id}', 'highCeiling', this.checked)"> æŒ‘é«˜</label>
                        </div>
                        <div class="options-row">
                            <label class="option-label"><input type="radio" name="roof_${space.id}" value="none" ${space.roof === 'none' ? 'checked' : ''} onchange="updateField('${space.id}', 'roof', this.value)"> ä¸€èˆ¬å±‹é ‚</label>
                            <label class="option-label"><input type="radio" name="roof_${space.id}" value="tin" ${space.roof === 'tin' ? 'checked' : ''} onchange="updateField('${space.id}', 'roof', this.value)"> éµçš®</label>
                            <label class="option-label"><input type="radio" name="roof_${space.id}" value="black_tin" ${space.roof === 'black_tin' ? 'checked' : ''} onchange="updateField('${space.id}', 'roof', this.value)"> é»‘éµçš®</label>
                        </div>
                    </div>
                    <div class="result-box" id="result_${space.id}">å»ºè­°èƒ½åŠ›ï¼šç´„ ${space.kw} kW</div>
                `;
                container.appendChild(card);
            });
        }
        function resetAll() {
            if (confirm("è­¦å‘Šï¼šç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è² è¼‰æ¸¬é‡è³‡æ–™å—ï¼Ÿ")) { appState.spaces = []; appState.spaceCounter = 1; addSpace(); }
        }
        function exportPDF() {
            const hasData = appState.spaces.some(space => parseFloat(space.kw) > 0 || parseFloat(space.ping) > 0);
            if (!hasData) { alert("ç›®å‰æ²’æœ‰ä»»ä½•æ¸¬é‡è³‡æ–™ï¼"); return; }
            const btn = document.getElementById('btn-export');
            btn.innerText = "ç”Ÿæˆè¡¨å–®ä¸­..."; btn.disabled = true;
            document.getElementById('main-ui').style.display = 'none';
            const printArea = createPrintArea('é¾ç¥åŠ©æ‰‹ - ç©ºé–“è² è¼‰å ±è¡¨');
            let textBlocks = '';
            appState.spaces.forEach((space) => {
                let conds = [];
                if (space.sun === 'west') conds.push('è¥¿æ›¬'); if (space.sun === 'all') conds.push('å…¨æ—¥æ›¬');
                if (space.topFloor) conds.push('é ‚æ¨“'); if (space.highCeiling) conds.push('æŒ‘é«˜');
                if (space.roof === 'tin') conds.push('éµçš®'); if (space.roof === 'black_tin') conds.push('é»‘éµçš®');
                let condText = conds.length > 0 ? conds.join('ã€') : 'ç„¡ç‰¹æ®Šç’°å¢ƒ';
                let dimText = (space.length && space.width) ? `${space.length} Ã— ${space.width} cm` : 'æœªå¡«å¯«å°ºå¯¸';
                let pingText = space.ping ? `${space.ping} åª` : 'æœªå¡«å¯«åªæ•¸';
                let kwText = space.kw > 0 ? `${space.kw} kW` : 'å°šæœªè¨ˆç®—';
                textBlocks += `
                    <div style="border-bottom: 1px dashed #ccc; padding: 15px 0; page-break-inside: avoid;">
                        <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">ğŸ”¸ ${space.name || 'æœªå‘½åç©ºé–“'}</div>
                        <div style="font-size: 16px; color: #333; line-height: 1.8;">
                            â€¢ æ¸¬é‡å°ºå¯¸ï¼š${dimText} ï½œ æ›ç®—åªæ•¸ï¼š${pingText}<br>
                            â€¢ ç’°å¢ƒæ¢ä»¶ï¼š${condText}<br>
                            <span style="color: #d32f2f; font-weight: bold; font-size: 18px;">ğŸ‘‰ å»ºè­°èƒ½åŠ›ï¼šç´„ ${kwText}</span>
                        </div>
                    </div>`;
            });
            printArea.innerHTML += textBlocks + getPdfFooter("èƒ½åŠ›å»ºè­°åƒ…ä¾›åˆæ­¥è©•ä¼°ï¼Œå¯¦éš›ä»¥ç¾å ´é…ç½®ç‚ºæº–ã€‚");
            executePdfExport(printArea, btn, 'ç©ºèª¿ç©ºé–“è² è¼‰è¨ˆç®—è¡¨.pdf');
        }

        /* ================================
           VIP å­åˆ†é ï¼šåŠéš±å¼é¢¨ç®¡è¦åŠƒ
           ================================ */
        function addFlange() {
            if (!isLoggedIn) return; 
            const newId = Date.now().toString();
            appState.flanges.push({ id: newId, name: 'é…ç½®' + appState.flangeCounter, w: '', h: '', t: '', area: 0, resultHtml: 'å»ºè­°é…ç½®ï¼šè«‹è¼¸å…¥å°ºå¯¸' });
            appState.flangeCounter++; saveDataSilently(); renderFlanges();
        }
        function removeFlange(id) {
            if (appState.flanges.length <= 1) { alert("ç„¡æ³•åˆªé™¤ï¼è¡¨å–®ä¸­è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹é…ç½®ã€‚"); return; }
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é…ç½®çš„è³‡æ–™å—ï¼Ÿ")) {
                appState.flanges = appState.flanges.filter(f => f.id !== id); saveDataSilently(); renderFlanges();
            }
        }
        function updateFlangeField(id, field, value) {
            if (!isLoggedIn) return;
            const flange = appState.flanges.find(f => f.id === id);
            if (!flange) return;
            flange[field] = value; saveDataSilently();
            if (flangeTimers[id]) clearTimeout(flangeTimers[id]);
            flangeTimers[id] = setTimeout(() => { fetchCloudflareAPI(flange); }, 600);
        }
        async function fetchCloudflareAPI(flange) {
            if (!isLoggedIn) return;
            let w = parseFloat(flange.w) || 0; let h = parseFloat(flange.h) || 0; let t = parseInt(flange.t) || 0;
            let areaTextId = 'flange_area_' + flange.id; let resBoxId = 'flange_res_' + flange.id;

            if (w <= 0 || h <= 0) {
                flange.area = 0; flange.resultHtml = "å»ºè­°é…ç½®ï¼šè«‹è¼¸å…¥å°ºå¯¸"; 
                document.getElementById(areaTextId).innerText = "0";
                document.getElementById(resBoxId).innerHTML = flange.resultHtml; document.getElementById(resBoxId).style.color = "#ffd700";
                return;
            }

            document.getElementById(resBoxId).innerHTML = "é€£ç·šé‹ç®—ä¸­ <span style='font-size:0.8em'>â³</span>";
            document.getElementById(resBoxId).style.color = "#aaaaaa";

            try {
                const response = await fetch('https://ryujin-god-api.mondogshahan.workers.dev', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ w: w, h: h, t: t, password: currentAuthToken })
                });
                const data = await response.json();
                if (data.error) {
                    flange.resultHtml = "æˆæ¬Šç¢¼ç„¡æ•ˆï¼Œç„¡æ³•åŸ·è¡Œé‹ç®—";
                    document.getElementById(resBoxId).innerHTML = `<span style="color:#ff4c4c;">${flange.resultHtml}</span>`;
                } else {
                    flange.area = data.area; flange.resultHtml = data.resultHtml;
                    document.getElementById(areaTextId).innerText = data.area > 0 ? data.area.toFixed(2).replace(/\.00$/, '') : '0';
                    document.getElementById(resBoxId).innerHTML = flange.resultHtml; document.getElementById(resBoxId).style.color = "#ffd700";
                }
            } catch (err) {
                flange.resultHtml = "é€£ç·šç•°å¸¸ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
                document.getElementById(resBoxId).innerHTML = `<span style="color:#ff4c4c;">${flange.resultHtml}</span>`;
            }
            saveDataSilently();
        }
        function renderFlanges() {
            const container = document.getElementById('flanges-container');
            container.innerHTML = '';
            appState.flanges.forEach((flange) => {
                const card = document.createElement('div'); card.className = 'space-card';
                card.innerHTML = `
                    <div class="space-header">
                        <input type="text" class="space-title-input" placeholder="é…ç½®åç¨±" value="${flange.name}" oninput="updateFlangeField('${flange.id}', 'name', this.value)">
                        <button class="delete-btn" onclick="removeFlange('${flange.id}')">åˆªé™¤</button>
                    </div>
                    <div class="input-grid">
                        <div class="input-group"><label>æ³•è˜­å¯¬åº¦ (cm)</label><input type="number" placeholder="è¼¸å…¥å¯¬åº¦" value="${flange.w}" oninput="updateFlangeField('${flange.id}', 'w', this.value)"></div>
                        <div class="input-group"><label>æ³•è˜­é«˜åº¦ (cm)</label><input type="number" placeholder="è¼¸å…¥é«˜åº¦" value="${flange.h}" oninput="updateFlangeField('${flange.id}', 'h', this.value)"></div>
                        <div class="input-group"><label>ç›®æ¨™å‡ºé¢¨å£æ•¸é‡</label><input type="number" placeholder="å¯é¸" value="${flange.t}" oninput="updateFlangeField('${flange.id}', 't', this.value)"></div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                        <span style="font-size: 1em; color: #aaa;">æ³•è˜­æˆªé¢ç©ï¼š</span>
                        <span id="flange_area_${flange.id}" style="color: #fff; font-size: 1.3em; font-weight: bold;">${flange.area > 0 ? flange.area.toFixed(2).replace(/\.00$/, '') : '0'}</span>
                        <span style="color: #aaa;"> cmÂ²</span>
                    </div>
                    <div class="result-box" id="flange_res_${flange.id}" style="margin-top: 15px;">
                        ${flange.resultHtml.includes("æˆæ¬Š") || flange.resultHtml.includes("ç•°å¸¸") ? `<span style="color:#ff4c4c;">${flange.resultHtml}</span>` : flange.resultHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        }
        function resetFlanges() {
            if (confirm("è­¦å‘Šï¼šç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ³•è˜­é…ç®¡è³‡æ–™å—ï¼Ÿ")) { appState.flanges = []; appState.flangeCounter = 1; addFlange(); }
        }
        function exportFlangePDF() {
            if (!isLoggedIn) { alert("ç³»çµ±å°šæœªè§£é–ï¼\nè«‹å…ˆè¼¸å…¥æ­£ç¢ºçš„æˆæ¬Šç¢¼ä¸¦ç¢ºèªé‹ç®—ç„¡èª¤å¾Œï¼Œå†åŒ¯å‡ºè¡¨å–®ã€‚"); return; }
            const hasData = appState.flanges.some(f => parseFloat(f.w) > 0 && parseFloat(f.h) > 0);
            if (!hasData) { alert("ç›®å‰æ²’æœ‰ä»»ä½•é…ç®¡è³‡æ–™ï¼"); return; }
            const btn = document.getElementById('btn-export-flange'); btn.innerText = "ç”Ÿæˆè¡¨å–®ä¸­..."; btn.disabled = true;
            document.getElementById('main-ui').style.display = 'none';
            const printArea = createPrintArea('é¾ç¥åŠ©æ‰‹ - é›†é¢¨ç®±é–‹å­”å»ºè­°è¡¨');
            let textBlocks = '';
            appState.flanges.forEach((f) => {
                let dimText = (f.w && f.h) ? `${f.w} Ã— ${f.h} cm` : 'æœªå¡«å¯«å°ºå¯¸';
                let areaText = f.area > 0 ? `${f.area.toFixed(2).replace(/\.00$/, '')} cmÂ²` : '0 cmÂ²';
                let targetText = f.t ? `${f.t} å€‹` : 'æœªæŒ‡å®š';
                let pureResult = f.resultHtml.replace(/<br>/g, " ").replace(/<[^>]+>/g, '').replace(/âš ï¸|âŒ/g, '');
                textBlocks += `
                    <div style="border-bottom: 1px dashed #ccc; padding: 15px 0; page-break-inside: avoid;">
                        <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">ğŸ”¸ ${f.name || 'æœªå‘½åé…ç½®'}</div>
                        <div style="font-size: 16px; color: #333; line-height: 1.8;">
                            â€¢ æ³•è˜­å°ºå¯¸ï¼š${dimText} ï½œ æˆªé¢ç©ï¼š${areaText}<br>
                            â€¢ ç›®æ¨™æ•¸é‡ï¼š${targetText}<br>
                            <span style="color: #1a73e8; font-weight: bold; font-size: 18px;">ğŸ‘‰ ${pureResult}</span>
                        </div>
                    </div>`;
            });
            printArea.innerHTML += textBlocks + getPdfFooter("é–‹å­”å»ºè­°ç”±ç³»çµ±æ™ºèƒ½è¨ˆç®—ï¼Œå¯¦éš›æ–½ä½œè«‹ä¾ç¾å ´é›†é¢¨ç®±çµæ§‹ç‚ºæº–ã€‚");
            executePdfExport(printArea, btn, 'åŠéš±å¼é›†é¢¨ç®±é–‹å­”å»ºè­°è¡¨.pdf');
        }

        /* ================================
           PDF åŒ¯å‡ºå·¥å…·
           ================================ */
        function createPrintArea(title) {
            const printArea = document.createElement('div'); printArea.id = 'print-area';
            printArea.style.backgroundColor = '#ffffff'; printArea.style.color = '#000000';
            printArea.style.padding = '30px'; printArea.style.minHeight = '100vh';
            printArea.style.fontFamily = "'Microsoft JhengHei', sans-serif";
            const today = new Date(); const dateString = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
            printArea.innerHTML = `
                <div style="border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px; display: flex; align-items: center;">
                    <h1 style="margin: 0; font-size: 26px; flex-grow: 1;">${title}</h1>
                    <div style="font-size: 14px; color: #666;">åˆ—å°æ—¥æœŸï¼š${dateString}</div>
                </div>`;
            document.body.appendChild(printArea); window.scrollTo(0, 0); return printArea;
        }
        function getPdfFooter(remarkText) { return `<div style="margin-top: 30px; font-size: 13px; color: #888;">* å‚™è¨»ï¼š${remarkText}</div>`; }
        function executePdfExport(printArea, btnElement, filename) {
            let pdfWindow;
            try { pdfWindow = window.open('', '_blank'); if (pdfWindow) pdfWindow.document.write('<div style="text-align:center; margin-top:50px; font-family:sans-serif; font-size: 1.2em; color: #333;">PDF ç”¢ç”Ÿä¸­ï¼Œè«‹ç¨å€™...</div>'); } 
            catch (e) { console.warn("ç„¡æ³•é–‹å•Ÿæ–°åˆ†é ", e); }
            html2pdf().set({ margin: 0.5, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } }).from(printArea).output('bloburl').then(function(pdfUrl) {
                document.body.removeChild(printArea); document.getElementById('main-ui').style.display = 'block';
                btnElement.innerText = "åŒ¯å‡º PDF è¡¨å–®"; btnElement.disabled = false;
                if (pdfWindow) { pdfWindow.location.href = pdfUrl; } else { let a = document.createElement('a'); a.href = pdfUrl; a.download = filename; a.click(); }
            }).catch((err) => {
                if(document.getElementById('print-area')) document.body.removeChild(printArea);
                document.getElementById('main-ui').style.display = 'block'; btnElement.innerText = "åŒ¯å‡º PDF è¡¨å–®"; btnElement.disabled = false;
                if(pdfWindow) pdfWindow.close(); alert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
            });
        }

        window.onload = loadData;
    </script>
</body>
</html>
