<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>龍神助手 - 空調負載計算</title>
    <link rel="icon" href="icon.png" type="image/png" sizes="512x512">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#1a1a1a">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* 基礎排版與龍神暗金色系 */
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        
        /* 頂部導航與分頁 */
        header {
            background: linear-gradient(145deg, #2a2a2a, #151515);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        h1 {
            margin: 0;
            color: #ffd700;
            font-size: 1.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            margin-right: auto;
        }
        .tab-btn {
            background: transparent;
            color: #aaaaaa;
            border: none;
            font-size: 1.1em;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: 0.3s;
        }
        .tab-btn.active {
            color: #ffd700;
            border-bottom: 2px solid #ffd700;
        }

        /* 內容區塊 */
        .tab-content {
            display: none;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        .tab-content.active {
            display: block;
        }

        /* 空間卡片設計 */
        .space-card {
            background: #242424;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .space-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        .space-title-input {
            background: transparent;
            border: none;
            color: #ffd700;
            font-size: 1.3em;
            font-weight: bold;
            width: 70%;
            outline: none;
        }
        .space-title-input::placeholder { color: #888; }

        .delete-btn {
            background: transparent;
            color: #ff4c4c;
            border: 1px solid #ff4c4c;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: 0.2s;
        }
        .delete-btn:hover {
            background: #ff4c4c;
            color: white;
        }

        /* 表單與選項網格 */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
        }
        .input-group input[type="number"] {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #444;
            background: #1a1a1a;
            color: #fff;
            outline: none;
        }
        .input-group input[type="number"]:focus {
            border-color: #ffd700;
        }
        
        .ping-input {
            color: #ffd700 !important;
            font-weight: bold;
        }
        
        /* 環境選項區塊 */
        .options-section {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .options-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        .options-row:last-child { margin-bottom: 0; }
        .option-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.95em;
            color: #ddd;
        }
        .option-label input { margin-right: 5px; }

        /* 結果顯示 */
        .result-box {
            text-align: right;
            font-size: 1.2em;
            color: #ffd700;
            font-weight: bold;
            padding-top: 10px;
        }

        /* 底部操作按鈕 */
        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 40px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-add { background: linear-gradient(145deg, #ffd700, #d4af37); color: #1a1a1a; }
        .btn-pdf { background: #4a90e2; color: white; }
        .btn-reset { background: transparent; border: 2px solid #ff4c4c; color: #ff4c4c; }
        .btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <header>
        <img src="icon.png" alt="龍神" class="header-logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIgZmlsbD0iI2ZmZDcwMCIvPjwvc3ZnPg=='">
        <h1>龍神助手</h1>
        <button class="tab-btn active" onclick="switchTab('calc')">負載計算</button>
        <button class="tab-btn" onclick="switchTab('settings')">其他設定</button>
    </header>

    <div id="calc" class="tab-content active">
        <div id="spaces-container">
            </div>

        <div class="action-bar">
            <button class="btn btn-add" onclick="addSpace()">+ 新增空間</button>
            <button class="btn btn-pdf" id="btn-export" onclick="exportPDF()">匯出 PDF 表單</button>
            <button class="btn btn-reset" onclick="resetAll()">重置資料</button>
        </div>
    </div>

    <div id="settings" class="tab-content">
        <p>這裡是其他分頁，切換過來再切回去，負載計算的資料依然會保留著。</p>
    </div>

    <script>
        let appState = {
            spaces: [],
            spaceCounter: 1
        };

        function loadData() {
            const savedData = localStorage.getItem('dragonGodSpaces');
            if (savedData) {
                let parsed = JSON.parse(savedData);
                if (Array.isArray(parsed)) {
                    appState.spaces = parsed;
                    appState.spaceCounter = parsed.length + 1;
                } else {
                    appState = parsed;
                }
            }
            if (appState.spaces.length === 0) {
                appState.spaceCounter = 1;
                addSpace(); 
            } else {
                renderSpaces(); 
            }
        }

        function saveDataSilently() {
            localStorage.setItem('dragonGodSpaces', JSON.stringify(appState));
        }

        function addSpace() {
            const newId = Date.now().toString();
            appState.spaces.push({
                id: newId,
                name: '空間' + appState.spaceCounter, 
                length: '',
                width: '',
                ping: '',
                sun: 'none', 
                roof: 'none', 
                topFloor: false, 
                highCeiling: false, 
                kw: 0
            });
            appState.spaceCounter++; 
            saveDataSilently();
            renderSpaces(); 
        }

        function removeSpace(id) {
            if (appState.spaces.length <= 1) {
                alert("無法刪除！表單中至少需要保留一個空間進行計算。");
                return;
            }
            if (confirm("確定要刪除這個空間的資料嗎？")) {
                appState.spaces = appState.spaces.filter(space => space.id !== id);
                saveDataSilently();
                renderSpaces();
            }
        }

        function updateField(id, field, value) {
            const space = appState.spaces.find(s => s.id === id);
            if (!space) return;

            space[field] = value;

            if (field === 'length' || field === 'width') {
                const l = parseFloat(space.length) || 0;
                const w = parseFloat(space.width) || 0;
                if (l > 0 && w > 0) {
                    const ping = ((l / 100) * (w / 100)) * 0.3025;
                    space.ping = ping.toFixed(2);
                    document.getElementById('ping_' + id).value = space.ping;
                } else {
                    space.ping = '';
                    document.getElementById('ping_' + id).value = '';
                }
            }

            const pingVal = parseFloat(space.ping) || 0;
            let kwVal = pingVal * 0.6; 
            
            if (kwVal > 0) {
                if (space.sun === 'west') kwVal *= 1.15;
                if (space.sun === 'all') kwVal *= 1.25;
                if (space.topFloor) kwVal *= 1.15;
                if (space.highCeiling) kwVal *= 1.10;
                if (space.roof === 'tin') kwVal *= 1.20;
                if (space.roof === 'black_tin') kwVal *= 1.30;
            }
            space.kw = kwVal.toFixed(2);
            
            document.getElementById('result_' + id).innerText = '建議能力：約 ' + space.kw + ' kW';

            saveDataSilently();
        }

        function renderSpaces() {
            const container = document.getElementById('spaces-container');
            container.innerHTML = '';

            appState.spaces.forEach((space) => {
                const card = document.createElement('div');
                card.className = 'space-card';
                card.innerHTML = `
                    <div class="space-header">
                        <input type="text" class="space-title-input" placeholder="空間名稱" 
                               value="${space.name}" oninput="updateField('${space.id}', 'name', this.value)">
                        <button class="delete-btn" onclick="removeSpace('${space.id}')">刪除</button>
                    </div>
                    
                    <div class="input-grid">
                        <div class="input-group">
                            <label>長度 (cm)</label>
                            <input type="number" placeholder="公分" value="${space.length}" 
                                   oninput="updateField('${space.id}', 'length', this.value)">
                        </div>
                        <div class="input-group">
                            <label>寬度 (cm)</label>
                            <input type="number" placeholder="公分" value="${space.width}" 
                                   oninput="updateField('${space.id}', 'width', this.value)">
                        </div>
                        <div class="input-group">
                            <label>坪數</label>
                            <input type="number" id="ping_${space.id}" class="ping-input" step="0.01" placeholder="可自動換算或手動" value="${space.ping}" 
                                   oninput="updateField('${space.id}', 'ping', this.value)">
                        </div>
                    </div>

                    <div class="options-section">
                        <div class="options-row">
                            <label class="option-label">
                                <input type="radio" name="sun_${space.id}" value="none" 
                                       ${space.sun === 'none' ? 'checked' : ''} 
                                       onchange="updateField('${space.id}', 'sun', this.value)"> 無西曬
                            </label>
                            <label class="option-label">
                                <input type="radio" name="sun_${space.id}" value="west" 
                                       ${space.sun === 'west' ? 'checked' : ''} 
                                       onchange="updateField('${space.id}', 'sun', this.value)"> 西曬
                            </label>
                            <label class="option-label">
                                <input type="radio" name="sun_${space.id}" value="all" 
                                       ${space.sun === 'all' ? 'checked' : ''} 
                                       onchange="updateField('${space.id}', 'sun', this.value)"> 全日曬
                            </label>
                        </div>
                        
                        <div class="options-row">
                            <label class="option-label">
                                <input type="checkbox" ${space.topFloor ? 'checked' : ''} 
                                       onchange="updateField('${space.id}', 'topFloor', this.checked)"> 頂樓
                            </label>
                            <label class="option-label">
                                <input type="checkbox" ${space.highCeiling ? 'checked' : ''} 
                                       onchange="updateField('${space.id}', 'highCeiling', this.checked)"> 挑高
                            </label>
                        </div>

                        <div class="options-row">
                            <label class="option-label">
                                <input type="radio" name="roof_${space.id}" value="none" 
                                       ${space.roof === 'none' ? 'checked' : ''} 
                                       onchange="updateField('${space.id}', 'roof', this.value)"> 一般屋頂
                            </label>
                            <label class="option-label">
                                <input type="radio" name="roof_${space.id}" value="tin" 
                                       ${space.roof === 'tin' ? 'checked' : ''} 
                                       onchange="updateField('${space.id}', 'roof', this.value)"> 鐵皮
                            </label>
                            <label class="option-label">
                                <input type="radio" name="roof_${space.id}" value="black_tin" 
                                       ${space.roof === 'black_tin' ? 'checked' : ''} 
                                       onchange="updateField('${space.id}', 'roof', this.value)"> 黑鐵皮
                            </label>
                        </div>
                    </div>

                    <div class="result-box" id="result_${space.id}">
                        建議能力：約 ${space.kw} kW
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function resetAll() {
            if (confirm("警告：您確定要清除所有測量資料與空間嗎？此動作無法復原！")) {
                localStorage.removeItem('dragonGodSpaces');
                appState.spaces = [];
                appState.spaceCounter = 1; 
                addSpace(); 
            }
        }

        function exportPDF() {
            // ★ 防呆機制：檢查是否至少有一個空間有算出 kW 或填寫坪數
            const hasData = appState.spaces.some(space => parseFloat(space.kw) > 0 || parseFloat(space.ping) > 0);
            if (!hasData) {
                alert("目前沒有任何測量資料！\n請至少在一個空間輸入「長寬」或「坪數」後再匯出表單。");
                return;
            }

            const btn = document.getElementById('btn-export');
            btn.innerText = "生成表單中...";
            btn.disabled = true;

            // ★ 修復空白 PDF：利用 height 0 與 overflow hidden 將區塊藏在一般文件流中，而不是拔出畫面
            const wrapper = document.createElement('div');
            wrapper.style.height = '0';
            wrapper.style.overflow = 'hidden';

            const pdfContainer = document.createElement('div');
            pdfContainer.style.width = '800px';
            pdfContainer.style.backgroundColor = '#ffffff';

            const today = new Date();
            const dateString = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;

            let tableRows = '';
            appState.spaces.forEach((space) => {
                let conditions = [];
                if (space.sun === 'west') conditions.push('西曬');
                if (space.sun === 'all') conditions.push('全日曬');
                if (space.topFloor) conditions.push('頂樓');
                if (space.highCeiling) conditions.push('挑高');
                if (space.roof === 'tin') conditions.push('鐵皮');
                if (space.roof === 'black_tin') conditions.push('黑鐵皮');
                
                let condText = conditions.length > 0 ? conditions.join('、') : '無特殊條件';
                let dimText = (space.length && space.width) ? `${space.length} × ${space.width}` : '-';
                let pingText = space.ping ? space.ping : '-';
                let kwText = space.kw > 0 ? space.kw : '-';

                tableRows += `
                    <tr>
                        <td style="border: 1px solid #333; padding: 12px 8px; font-weight: bold;">${space.name || '未命名'}</td>
                        <td style="border: 1px solid #333; padding: 12px 8px; text-align: center;">${dimText}</td>
                        <td style="border: 1px solid #333; padding: 12px 8px; text-align: center;">${pingText}</td>
                        <td style="border: 1px solid #333; padding: 12px 8px; color: #555;">${condText}</td>
                        <td style="border: 1px solid #333; padding: 12px 8px; text-align: right; font-weight: bold; color: #d32f2f; font-size: 1.1em;">${kwText}</td>
                    </tr>
                `;
            });

            pdfContainer.innerHTML = `
                <div style="padding: 40px; font-family: 'Microsoft JhengHei', sans-serif; color: #000; background: #fff; width: 800px; box-sizing: border-box;">
                    <div style="display: flex; align-items: center; border-bottom: 3px solid #1a1a1a; padding-bottom: 15px; margin-bottom: 30px;">
                        <img src="icon.png" style="width: 70px; height: 70px; border-radius: 20%; margin-right: 20px; object-fit: cover;" onerror="this.style.display='none'">
                        <div style="flex-grow: 1;">
                            <h1 style="margin: 0; font-size: 28px; color: #1a1a1a; letter-spacing: 2px;">龍神助手</h1>
                            <h2 style="margin: 5px 0 0 0; font-size: 20px; color: #666; font-weight: normal;">空調空間負載計算表</h2>
                        </div>
                        <div style="text-align: right; font-size: 14px; color: #444;">
                            列印日期：${dateString}
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; font-size: 15px;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="border: 1px solid #333; padding: 12px 8px; text-align: left; width: 20%;">空間名稱</th>
                                <th style="border: 1px solid #333; padding: 12px 8px; text-align: center; width: 20%;">尺寸 (長×寬 cm)</th>
                                <th style="border: 1px solid #333; padding: 12px 8px; text-align: center; width: 15%;">坪數</th>
                                <th style="border: 1px solid #333; padding: 12px 8px; text-align: left; width: 25%;">環境條件</th>
                                <th style="border: 1px solid #333; padding: 12px 8px; text-align: right; width: 20%;">建議能力 (kW)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 40px; font-size: 13px; color: #888; border-top: 1px solid #ddd; padding-top: 10px;">
                        * 備註：此表單之能力建議為初步評估，實際機型選擇需視現場管線配置與客戶需求而定。
                    </div>
                </div>
            `;

            wrapper.appendChild(pdfContainer);
            document.body.appendChild(wrapper);

            const opt = {
                margin:       [0.5, 0.5, 0.5, 0.5],
                filename:     '空調空間負載計算表.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, logging: false },
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(pdfContainer).save().then(() => {
                document.body.removeChild(wrapper);
                btn.innerText = "匯出 PDF 表單";
                btn.disabled = false;
            }).catch((err) => {
                console.error("PDF 匯出錯誤: ", err);
                document.body.removeChild(wrapper);
                btn.innerText = "匯出 PDF 表單";
                btn.disabled = false;
                alert("匯出失敗，請確保圖片已正確載入。");
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        window.onload = loadData;
    </script>
</body>
</html>
